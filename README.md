# yuque-publish
让语雀作为静态博客的后端管理和编辑器，利用Webhook实现自动化部署。

## 使用
1. 配置`.env`文件

`$ touch .env`  
输入以下的变量信息
```env
TOKEN='' #语雀的个人token(https://www.yuque.com/settings/tokens)
NAMESPACE='' #语雀的namespace,例如`zjan/bwcmnq`,在url中可以看到。
DESDIR='' #文档下载到哪个目录，可以按分组生成子文件夹
WORKDIR='' #cmd工作目录，比如hugo静态生成的文件夹目录
CMD='' #下载后可以自动执行的命令，比如`hugo g`
```

2. 初始化

**如果文档已经写了很多了，那么可以先全部下载下来，然后再进行管理**
```python
$ pip install -r requirements.txt
$ python task.py #单线程的可能比较慢
```
3. 启动server服务器
```python
$ python app.py #默认监听8080端口
```

4. 配置语雀Webhook功能
    - 为知识库新建一个消息推送的机器人
    - 机器人的webhook地址为http://ip:port,建议反代一下ip
    - 权限选择`发布文档`，`更新文档`,`新增评论`

5. 管理文档
    1. 发布文档
        - 目前只支持markdown的格式，yuque特有的格式不支持，因为api里面没有这部分内容。
        - 图片防盗链已经处理，后续会把图片拉到本地让后上传到图床
        - 支持Front Matter，在语雀中很难看，后面美化一下
        - 建议关闭自动发布，好像有时候不推送
    2. 更新文档
        - 正常更新即可
        - 如果是移动或者复制到其他分组，并不会触发webhook请求，建议先<删除文档>再移动后再更新文档。
    3. 删除文档 
        - 语雀的删除不会触发webhook也是奇葩，所以利用评论功能来触发删除了。
        - 评论里面带有`#closed`的都会触发删除，然后再把文档删除即可。

6. 文档分组

**支持文档树的结构，这样可以比较方便的管理文档**  

**注意：是分组，不是文档下的子文档。**

语雀创建分组
- 知识库选择目录结构
- 目录管理
- 新建分组

下载的文件树结构
```
-目录
--分组1
----文档1
----文档2
--分组2
----文档3
----文档4
```
发布的文档会自动下载到对应的分组，目前分组只支持1级的分组，分组下在分组不支持。

## TODO
- [ ] 完善错误逻辑和日志
- [ ] 图片下载到本地并可以上传到图床
- [ ] 处理语雀的引用
